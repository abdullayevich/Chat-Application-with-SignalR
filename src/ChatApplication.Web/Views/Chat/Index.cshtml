@using ChatApplication.Domain.Entities
@model IList<GroupChat>
@{
    ViewData["Title"] = "All Chats";
}

<h2>All Chats</h2>
<a asp-controller="Chat" asp-action="ChatRoom" class="btn btn-primary open-chat">Guruhlarda yozish</a>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Group Name</th>
            <th>Created By ID</th>
            <th>Created At</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var chat in Model)
        {
                <tr>
                    <td>@chat.Id</td>
                    <td>
                    <td>@chat.GroupName</td>
                    </td>
                    <td>@chat.CreatedById</td>
                    <td>@chat.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                </tr>
        }
    </tbody>
</table>
@* 
<!-- Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" role="dialog" aria-labelledby="chatModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatModalLabel">Chat Window</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="chatMessages" style="max-height: 300px; overflow-y: auto;">Loading chat...</div>
                <hr />
                    <input type="hidden" name=ReceiverId value="groupId" />
                    <div class="form-group">
                        <textarea name="MessageContent" id="MessageContent" class="form-control" placeholder="Enter your message..."></textarea>
                    </div>
                    <div class="modal-footer">
                    <button type="submit" id="submitModalForm" class="btn btn-primary">Send</button>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button"  class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>

            <script>
                // signalR uchun pastda
                    const connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

        connection.start().then(function () {
            console.log("Connected to SignalR");
        }).catch(function (err) {
            console.error("SignalR Connection Error: ", err.toString());
        });
            // signalR uchun tepada

                // signalR uchun pastda
                connection.on("ReceiveMessage", function (senderId, message) {
                const chatBox = $('#chatMessages');
                const messageElement = document.createElement("div");
                messageElement.innerHTML = `
                <div class="message">
                <div>User ID: <strong>${senderId}</strong></<div>
                <div>User Name: <strong>Men</strong}</div>
                <div>Message: <strong>${message}</strong}</div>
                </div>: ${message}`;
                chatBox.appendChild(messageElement);
        });
            // signalR uchun tepada



            // button uchun
                $(document).ready(function () {
        $('#submitModalForm').click(function () {
                var groupId = $(this).data('group-id');
                $('#groupId').val(groupId);
            var formData = {
                MessageContent: $('#MessageContent').val(),
                GroupId: groupId,
                SenderId: '0',
                ReceiverId: '0'
            };

            $.ajax({
                type: 'POST',
                url: '/SendMessageToGroup', // Controller va Action metodi
                data: formData,
                success: function (response) {
                    alert('Form submitted successfully!');
                    $('#myModal').modal('hide');
                },
                error: function (error) {
                    alert('Error while submitting the form');
                }
            });
        });
    });
    // button uchun


                $(document).ready(function() {
                    $('.open-chat').click(function() {
                        var groupId = $(this).data('group-id');
                        $('#groupId').val(groupId);

                            $.get('/Chat/' + groupId, function(data) {
                            console.log(data);
                            var chatMessages = $('#chatMessages');
                            chatMessages.html(''); // Oldingi xabarlarni tozalash


                                data.forEach(function(message) {
                                    var messageHtml = `
                                    <div class="message">
                                        <div>User ID: <strong>${message.id}</strong></div>
                                            <div>User Name: <strong>${message.fromUserName}</strong></div>
                                        <div>Message: ${message.messageContent}</div>
                                        <hr />
                                        </div>`;
                                chatMessages.append(messageHtml);
                            });
                        });
                    });

                    $('#chatForm').submit(function(e) {
                        e.preventDefault();
                        var groupId = $('#groupId').val();
                        var message = $('#message').val();

                        // Send the message via AJAX
                        $.post('/Group/SendMessage', { groupId: groupId, message: message }, function() {
                            // Add the message to the chat window
                            $('#chatMessages').append('<div>' + message + '</div>');
                            $('#message').val(''); // Clear the textarea
                        });
                    });
                });
            </script>
}
 *@